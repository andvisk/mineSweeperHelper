package minesweeperhelper;

import static org.junit.jupiter.api.Assertions.assertEquals;

import java.io.File;
import java.util.List;

import org.junit.jupiter.api.Test;
import org.opencv.core.Core;
import org.opencv.core.Mat;
import org.opencv.imgcodecs.Imgcodecs;

public class ProcessingServiceTest {
        @Test
        void runTest() {

                System.loadLibrary(Core.NATIVE_LIBRARY_NAME);

                Mat screenShot = Imgcodecs.imread("src/test/resources/screenshot.png");

                ProcessingService service = new ProcessingService(screenShot,
                                ControllerMain.MIN_WIDTH, ControllerMain.MIN_HEIGHT,
                                ControllerMain.TOLLERANCE_IN_PERCENT, null);
                ProcessingData processingData = service.prepareData(null);

                HelpScreenResult result = HelpScreen.process(screenShot, processingData.listScreenShotAreas(),
                                processingData.map(),
                                ControllerMain.TOLLERANCE_IN_PERCENT, null);

                Mat finalResult = result.image();

                FileUtils.checkDirExists(ProcessingService.debugDir, false);

                Imgcodecs.imwrite(ProcessingService.debugDir + File.separatorChar + "debug_final.png", finalResult);

                List<Board> boards = result.mapBoards().entrySet().stream().flatMap(p -> p.getValue().stream())
                                .toList();

                assertEquals(1, boards.size());

                Board board = boards.get(0);

                int[][] expectedNumbers = getBoardNumbers();

                assertEquals(expectedNumbers[0].length, board.getGrid()[0].length);

                for (int i = 0; i < expectedNumbers.length; i++) {
                        assertEquals(expectedNumbers[i].length, board.getGrid()[i].length);
                        for (int k = 0; k < expectedNumbers[i].length; k++) {
                                assertEquals(expectedNumbers[i][k], board.getGrid()[i][k].getNumber());
                        }
                }
        }

        private int[][] getBoardNumbers() {
                int[][] data = new int[30][16];

                data[0][0] = 0;
                data[1][0] = 0;
                data[2][0] = 0;
                data[3][0] = 0;
                data[4][0] = 0;
                data[5][0] = 0;
                data[6][0] = 0;
                data[7][0] = 0;
                data[8][0] = 0;
                data[9][0] = 0;
                data[10][0] = 0;
                data[11][0] = 0;
                data[12][0] = 0;
                data[13][0] = 0;
                data[14][0] = 2;
                data[15][0] = 0;
                data[16][0] = 2;
                data[17][0] = 0;
                data[18][0] = 2;
                data[19][0] = 0;
                data[20][0] = 0;
                data[21][0] = 0;
                data[22][0] = 1;
                data[23][0] = 0;
                data[24][0] = 3;
                data[25][0] = 2;
                data[26][0] = 1;
                data[27][0] = 1;
                data[28][0] = 2;
                data[29][0] = 2;
                data[0][1] = 0;
                data[1][1] = 0;
                data[2][1] = 0;
                data[3][1] = 0;
                data[4][1] = 0;
                data[5][1] = 0;
                data[6][1] = 0;
                data[7][1] = 0;
                data[8][1] = 0;
                data[9][1] = 0;
                data[10][1] = 0;
                data[11][1] = 0;
                data[12][1] = 0;
                data[13][1] = 0;
                data[14][1] = 2;
                data[15][1] = 0;
                data[16][1] = 3;
                data[17][1] = 0;
                data[18][1] = 3;
                data[19][1] = 1;
                data[20][1] = 1;
                data[21][1] = 1;
                data[22][1] = 1;
                data[23][1] = 3;
                data[24][1] = 0;
                data[25][1] = 0;
                data[26][1] = 2;
                data[27][1] = 1;
                data[28][1] = 0;
                data[29][1] = 0;
                data[0][2] = 0;
                data[1][2] = 0;
                data[2][2] = 0;
                data[3][2] = 0;
                data[4][2] = 0;
                data[5][2] = 0;
                data[6][2] = 0;
                data[7][2] = 0;
                data[8][2] = 0;
                data[9][2] = 0;
                data[10][2] = 0;
                data[11][2] = 0;
                data[12][2] = 0;
                data[13][2] = 4;
                data[14][2] = 3;
                data[15][2] = 1;
                data[16][2] = 2;
                data[17][2] = 0;
                data[18][2] = 2;
                data[19][2] = 1;
                data[20][2] = 0;
                data[21][2] = 1;
                data[22][2] = 0;
                data[23][2] = 2;
                data[24][2] = 0;
                data[25][2] = 0;
                data[26][2] = 2;
                data[27][2] = 1;
                data[28][2] = 2;
                data[29][2] = 2;
                data[0][3] = 0;
                data[1][3] = 0;
                data[2][3] = 0;
                data[3][3] = 0;
                data[4][3] = 0;
                data[5][3] = 0;
                data[6][3] = 0;
                data[7][3] = 0;
                data[8][3] = 0;
                data[9][3] = 0;
                data[10][3] = 0;
                data[11][3] = 0;
                data[12][3] = 0;
                data[13][3] = 0;
                data[14][3] = 0;
                data[15][3] = 1;
                data[16][3] = 2;
                data[17][3] = 2;
                data[18][3] = 2;
                data[19][3] = 1;
                data[20][3] = 1;
                data[21][3] = 1;
                data[22][3] = 0;
                data[23][3] = 1;
                data[24][3] = 2;
                data[25][3] = 2;
                data[26][3] = 1;
                data[27][3] = 0;
                data[28][3] = 0;
                data[29][3] = 0;
                data[0][4] = 0;
                data[1][4] = 0;
                data[2][4] = 0;
                data[3][4] = 0;
                data[4][4] = 0;
                data[5][4] = 0;
                data[6][4] = 0;
                data[7][4] = 0;
                data[8][4] = 0;
                data[9][4] = 0;
                data[10][4] = 0;
                data[11][4] = 0;
                data[12][4] = 0;
                data[13][4] = 0;
                data[14][4] = 3;
                data[15][4] = 1;
                data[16][4] = 1;
                data[17][4] = 0;
                data[18][4] = 1;
                data[19][4] = 0;
                data[20][4] = 1;
                data[21][4] = 1;
                data[22][4] = 1;
                data[23][4] = 0;
                data[24][4] = 0;
                data[25][4] = 0;
                data[26][4] = 0;
                data[27][4] = 0;
                data[28][4] = 1;
                data[29][4] = 1;
                data[0][5] = 0;
                data[1][5] = 0;
                data[2][5] = 0;
                data[3][5] = 0;
                data[4][5] = 0;
                data[5][5] = 0;
                data[6][5] = 2;
                data[7][5] = 2;
                data[8][5] = 2;
                data[9][5] = 0;
                data[10][5] = 0;
                data[11][5] = 0;
                data[12][5] = 3;
                data[13][5] = 2;
                data[14][5] = 1;
                data[15][5] = 0;
                data[16][5] = 1;
                data[17][5] = 1;
                data[18][5] = 1;
                data[19][5] = 0;
                data[20][5] = 2;
                data[21][5] = 0;
                data[22][5] = 2;
                data[23][5] = 0;
                data[24][5] = 0;
                data[25][5] = 0;
                data[26][5] = 0;
                data[27][5] = 1;
                data[28][5] = 2;
                data[29][5] = 0;
                data[0][6] = 0;
                data[1][6] = 0;
                data[2][6] = 0;
                data[3][6] = 0;
                data[4][6] = 0;
                data[5][6] = 0;
                data[6][6] = 0;
                data[7][6] = 1;
                data[8][6] = 0;
                data[9][6] = 0;
                data[10][6] = 0;
                data[11][6] = 0;
                data[12][6] = 0;
                data[13][6] = 1;
                data[14][6] = 0;
                data[15][6] = 1;
                data[16][6] = 1;
                data[17][6] = 1;
                data[18][6] = 0;
                data[19][6] = 0;
                data[20][6] = 2;
                data[21][6] = 0;
                data[22][6] = 2;
                data[23][6] = 0;
                data[24][6] = 1;
                data[25][6] = 1;
                data[26][6] = 1;
                data[27][6] = 1;
                data[28][6] = 0;
                data[29][6] = 3;
                data[0][7] = 0;
                data[1][7] = 0;
                data[2][7] = 0;
                data[3][7] = 4;
                data[4][7] = 0;
                data[5][7] = 3;
                data[6][7] = 1;
                data[7][7] = 1;
                data[8][7] = 1;
                data[9][7] = 3;
                data[10][7] = 0;
                data[11][7] = 6;
                data[12][7] = 0;
                data[13][7] = 4;
                data[14][7] = 2;
                data[15][7] = 3;
                data[16][7] = 0;
                data[17][7] = 2;
                data[18][7] = 0;
                data[19][7] = 0;
                data[20][7] = 2;
                data[21][7] = 3;
                data[22][7] = 3;
                data[23][7] = 2;
                data[24][7] = 2;
                data[25][7] = 0;
                data[26][7] = 2;
                data[27][7] = 2;
                data[28][7] = 3;
                data[29][7] = 0;
                data[0][8] = 0;
                data[1][8] = 0;
                data[2][8] = 3;
                data[3][8] = 0;
                data[4][8] = 2;
                data[5][8] = 1;
                data[6][8] = 0;
                data[7][8] = 0;
                data[8][8] = 0;
                data[9][8] = 1;
                data[10][8] = 2;
                data[11][8] = 0;
                data[12][8] = 0;
                data[13][8] = 0;
                data[14][8] = 0;
                data[15][8] = 3;
                data[16][8] = 0;
                data[17][8] = 2;
                data[18][8] = 0;
                data[19][8] = 0;
                data[20][8] = 1;
                data[21][8] = 0;
                data[22][8] = 0;
                data[23][8] = 2;
                data[24][8] = 0;
                data[25][8] = 3;
                data[26][8] = 0;
                data[27][8] = 2;
                data[28][8] = 4;
                data[29][8] = 0;
                data[0][9] = 0;
                data[1][9] = 0;
                data[2][9] = 0;
                data[3][9] = 2;
                data[4][9] = 1;
                data[5][9] = 0;
                data[6][9] = 0;
                data[7][9] = 0;
                data[8][9] = 1;
                data[9][9] = 1;
                data[10][9] = 2;
                data[11][9] = 3;
                data[12][9] = 4;
                data[13][9] = 4;
                data[14][9] = 2;
                data[15][9] = 2;
                data[16][9] = 1;
                data[17][9] = 1;
                data[18][9] = 0;
                data[19][9] = 1;
                data[20][9] = 2;
                data[21][9] = 4;
                data[22][9] = 3;
                data[23][9] = 3;
                data[24][9] = 1;
                data[25][9] = 3;
                data[26][9] = 3;
                data[27][9] = 0;
                data[28][9] = 3;
                data[29][9] = 0;
                data[0][10] = 0;
                data[1][10] = 0;
                data[2][10] = 3;
                data[3][10] = 3;
                data[4][10] = 1;
                data[5][10] = 1;
                data[6][10] = 0;
                data[7][10] = 0;
                data[8][10] = 1;
                data[9][10] = 0;
                data[10][10] = 1;
                data[11][10] = 1;
                data[12][10] = 0;
                data[13][10] = 1;
                data[14][10] = 0;
                data[15][10] = 0;
                data[16][10] = 0;
                data[17][10] = 0;
                data[18][10] = 0;
                data[19][10] = 1;
                data[20][10] = 0;
                data[21][10] = 2;
                data[22][10] = 0;
                data[23][10] = 1;
                data[24][10] = 0;
                data[25][10] = 1;
                data[26][10] = 0;
                data[27][10] = 2;
                data[28][10] = 2;
                data[29][10] = 1;
                data[0][11] = 0;
                data[1][11] = 0;
                data[2][11] = 0;
                data[3][11] = 2;
                data[4][11] = 0;
                data[5][11] = 1;
                data[6][11] = 1;
                data[7][11] = 1;
                data[8][11] = 3;
                data[9][11] = 2;
                data[10][11] = 2;
                data[11][11] = 1;
                data[12][11] = 1;
                data[13][11] = 1;
                data[14][11] = 0;
                data[15][11] = 0;
                data[16][11] = 0;
                data[17][11] = 0;
                data[18][11] = 0;
                data[19][11] = 2;
                data[20][11] = 2;
                data[21][11] = 3;
                data[22][11] = 1;
                data[23][11] = 1;
                data[24][11] = 0;
                data[25][11] = 2;
                data[26][11] = 3;
                data[27][11] = 4;
                data[28][11] = 3;
                data[29][11] = 2;
                data[0][12] = 0;
                data[1][12] = 0;
                data[2][12] = 3;
                data[3][12] = 2;
                data[4][12] = 1;
                data[5][12] = 1;
                data[6][12] = 2;
                data[7][12] = 0;
                data[8][12] = 3;
                data[9][12] = 0;
                data[10][12] = 1;
                data[11][12] = 0;
                data[12][12] = 0;
                data[13][12] = 0;
                data[14][12] = 0;
                data[15][12] = 0;
                data[16][12] = 0;
                data[17][12] = 0;
                data[18][12] = 0;
                data[19][12] = 1;
                data[20][12] = 0;
                data[21][12] = 1;
                data[22][12] = 0;
                data[23][12] = 0;
                data[24][12] = 0;
                data[25][12] = 1;
                data[26][12] = 0;
                data[27][12] = 0;
                data[28][12] = 0;
                data[29][12] = 0;
                data[0][13] = 0;
                data[1][13] = 0;
                data[2][13] = 2;
                data[3][13] = 0;
                data[4][13] = 1;
                data[5][13] = 2;
                data[6][13] = 5;
                data[7][13] = 0;
                data[8][13] = 6;
                data[9][13] = 3;
                data[10][13] = 3;
                data[11][13] = 1;
                data[12][13] = 1;
                data[13][13] = 1;
                data[14][13] = 1;
                data[15][13] = 1;
                data[16][13] = 0;
                data[17][13] = 1;
                data[18][13] = 2;
                data[19][13] = 4;
                data[20][13] = 3;
                data[21][13] = 2;
                data[22][13] = 0;
                data[23][13] = 1;
                data[24][13] = 1;
                data[25][13] = 2;
                data[26][13] = 2;
                data[27][13] = 4;
                data[28][13] = 0;
                data[29][13] = 3;
                data[0][14] = 0;
                data[1][14] = 0;
                data[2][14] = 2;
                data[3][14] = 1;
                data[4][14] = 1;
                data[5][14] = 0;
                data[6][14] = 0;
                data[7][14] = 0;
                data[8][14] = 0;
                data[9][14] = 0;
                data[10][14] = 3;
                data[11][14] = 0;
                data[12][14] = 1;
                data[13][14] = 1;
                data[14][14] = 0;
                data[15][14] = 1;
                data[16][14] = 0;
                data[17][14] = 1;
                data[18][14] = 0;
                data[19][14] = 0;
                data[20][14] = 0;
                data[21][14] = 1;
                data[22][14] = 0;
                data[23][14] = 1;
                data[24][14] = 0;
                data[25][14] = 1;
                data[26][14] = 0;
                data[27][14] = 1;
                data[28][14] = 1;
                data[29][14] = 1;
                data[0][15] = 0;
                data[1][15] = 2;
                data[2][15] = 0;
                data[3][15] = 1;
                data[4][15] = 1;
                data[5][15] = 3;
                data[6][15] = 0;
                data[7][15] = 0;
                data[8][15] = 0;
                data[9][15] = 0;
                data[10][15] = 3;
                data[11][15] = 1;
                data[12][15] = 1;
                data[13][15] = 1;
                data[14][15] = 1;
                data[15][15] = 1;
                data[16][15] = 0;
                data[17][15] = 1;
                data[18][15] = 2;
                data[19][15] = 3;
                data[20][15] = 2;
                data[21][15] = 1;
                data[22][15] = 0;
                data[23][15] = 1;
                data[24][15] = 1;
                data[25][15] = 1;
                data[26][15] = 0;
                data[27][15] = 0;
                data[28][15] = 0;
                data[29][15] = 0;

                return data;
        }

}
